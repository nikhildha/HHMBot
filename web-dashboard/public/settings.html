<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTINEL â€” Engine Architecture & Settings</title>
    <meta name="description"
        content="Complete architecture, workflow, and configuration reference for the SENTINEL Regime Engine">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
    <style>
        /* â”€â”€â”€ Tab Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .settings-tabs {
            display: flex;
            gap: 0;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-light);
            position: sticky;
            top: 0;
            z-index: 90;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .settings-tabs::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 28px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-tertiary);
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.25s ease;
            position: relative;
            margin-bottom: -2px;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: rgba(59, 130, 246, 0.04);
        }

        .tab-btn.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }

        .tab-btn .tab-icon {
            font-size: 18px;
        }

        .tab-btn .tab-count {
            font-size: 11px;
            font-weight: 700;
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-blue);
            padding: 1px 7px;
            border-radius: 10px;
        }

        .tab-pane {
            display: none;
            animation: fadeInTab 0.3s ease;
        }

        .tab-pane.active {
            display: block;
        }

        @keyframes fadeInTab {
            from {
                opacity: 0;
                transform: translateY(6px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* â”€â”€â”€ Settings Page Specific â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .settings-main {
            max-width: 1100px;
            margin: 0 auto;
            padding: 24px 20px 80px;
        }

        .page-hero {
            text-align: center;
            padding: 40px 20px 32px;
        }

        .page-hero h1 {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .page-hero p {
            font-size: 15px;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Section cards */
        .arch-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-card);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .arch-section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
        }

        .arch-section-header:hover {
            background: rgba(59, 130, 246, 0.04);
        }

        .arch-section-header .emoji {
            font-size: 24px;
        }

        .arch-section-header h2 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            flex: 1;
        }

        .arch-section-header .toggle {
            font-size: 18px;
            color: var(--text-tertiary);
            transition: transform 0.3s;
        }

        .arch-section.collapsed .arch-section-body {
            display: none;
        }

        .arch-section.collapsed .toggle {
            transform: rotate(-90deg);
        }

        .arch-section-body {
            padding: 24px;
        }

        /* Step boxes */
        .step-flow {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .step-box {
            display: flex;
            gap: 16px;
            padding: 16px 0;
        }

        .step-num {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .step-content h3 {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .step-content p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .step-connector {
            width: 2px;
            height: 16px;
            background: linear-gradient(180deg, var(--accent-blue), var(--accent-purple));
            margin-left: 17px;
            opacity: 0.3;
        }

        /* Config tables */
        .config-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .config-table th {
            text-align: left;
            padding: 10px 12px;
            background: var(--bg-card-alt);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-light);
        }

        .config-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
        }

        .config-table tr:last-child td {
            border-bottom: none;
        }

        .config-table .param-name {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 12px;
            color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.08);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .config-table .param-value {
            font-weight: 600;
            color: var(--accent-purple);
        }

        /* Architecture diagram (ASCII style) */
        .arch-diagram {
            background: var(--bg-card-dark);
            border-radius: var(--radius-md);
            padding: 24px;
            overflow-x: auto;
            margin: 16px 0;
        }

        .arch-diagram pre {
            color: var(--text-on-dark);
            font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
            font-size: 12px;
            line-height: 1.6;
            white-space: pre;
            margin: 0;
        }

        .arch-diagram .accent {
            color: #60A5FA;
        }

        .arch-diagram .green {
            color: #4ADE80;
        }

        .arch-diagram .yellow {
            color: #FBBF24;
        }

        .arch-diagram .red {
            color: #F87171;
        }

        .arch-diagram .purple {
            color: #A78BFA;
        }

        .arch-diagram .dim {
            color: rgba(240, 244, 248, 0.4);
        }

        /* Info badges */
        .badge-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 12px 0;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-bull {
            background: rgba(34, 197, 94, 0.12);
            color: #16A34A;
        }

        .badge-bear {
            background: rgba(239, 68, 68, 0.12);
            color: #DC2626;
        }

        .badge-chop {
            background: rgba(245, 158, 11, 0.12);
            color: #D97706;
        }

        .badge-crash {
            background: rgba(220, 38, 38, 0.12);
            color: #991B1B;
        }

        .badge-blue {
            background: rgba(59, 130, 246, 0.12);
            color: #2563EB;
        }

        .badge-purple {
            background: rgba(139, 92, 246, 0.12);
            color: #7C3AED;
        }

        /* Logic blocks */
        .logic-block {
            background: var(--bg-card-alt);
            border-radius: var(--radius-sm);
            padding: 16px 20px;
            margin: 12px 0;
            border-left: 3px solid var(--accent-blue);
        }

        .logic-block h4 {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .logic-block p,
        .logic-block li {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .logic-block ul {
            padding-left: 20px;
            margin-top: 6px;
        }

        .logic-block.green {
            border-left-color: var(--accent-green);
        }

        .logic-block.red {
            border-left-color: var(--accent-red);
        }

        .logic-block.yellow {
            border-left-color: var(--accent-yellow);
        }

        .logic-block.purple {
            border-left-color: var(--accent-purple);
        }

        .sub-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 20px 0 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Code inline */
        code {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 12px;
            background: rgba(59, 130, 246, 0.08);
            padding: 1px 5px;
            border-radius: 3px;
            color: var(--accent-blue);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .page-hero h1 {
                font-size: 24px;
            }

            .arch-section-body {
                padding: 16px;
            }

            .config-table {
                font-size: 12px;
            }
        }
    </style>
</head>

<body>

    <!-- â•â•â• Header â•â•â• -->
    <header class="header">
        <div class="logo">
            <div>
                <div class="logo-text">SENTINEL</div>
                <div class="logo-subtitle">AI Trading Command Center</div>
            </div>
        </div>
        <nav class="header-nav">
            <a href="/" class="nav-link">Dashboard</a>
            <a href="/tradebook" class="nav-link">Tradebook</a>
            <a href="/charts" class="nav-link">Charts</a>
            <a href="/backtest" class="nav-link">Backtest</a>
            <a href="/deploy" class="nav-link">Deploy</a>
            <a href="/settings" class="nav-link active">Settings</a>
        </nav>
        <div class="header-right">
            <span class="timestamp">Engine Architecture</span>
        </div>
    </header>

    <div class="settings-main">

        <!-- â•â•â• Page Hero â•â•â• -->
        <div class="page-hero">
            <h1>âš™ï¸ Regime Engine Architecture</h1>
            <p>Complete step-by-step logic, architecture, and configuration reference for the SENTINEL trading engine
            </p>
        </div>

        <!-- â•â•â• Tab Bar â•â•â• -->
        <div class="settings-tabs">
            <button class="tab-btn active" onclick="switchTab('architecture', this)">
                <span class="tab-icon">ğŸ—ï¸</span> Architecture <span class="tab-count">3</span>
            </button>
            <button class="tab-btn" onclick="switchTab('configuration', this)">
                <span class="tab-icon">âš™ï¸</span> Configuration <span class="tab-count">5</span>
            </button>
            <button class="tab-btn" onclick="switchTab('integrations', this)">
                <span class="tab-icon">ğŸ”Œ</span> Integrations
            </button>
            <button class="tab-btn" onclick="switchTab('research', this)">
                <span class="tab-icon">ğŸ”¬</span> Research
            </button>
        </div>

        <!-- â•â•â• TAB 1: ARCHITECTURE â•â•â• -->
        <div class="tab-pane active" id="tab-architecture">

            <!-- â•â•â• 1. HIGH-LEVEL ARCHITECTURE â•â•â• -->
            <div class="arch-section">
                <div class="arch-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <span class="emoji">ğŸ—ï¸</span>
                    <h2>System Architecture</h2>
                    <span class="toggle">â–¼</span>
                </div>
                <div class="arch-section-body">

                    <div class="arch-diagram">
                        <pre>
<span class="dim">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="dim">â”‚</span>                    <span class="accent">SENTINEL REGIME ENGINE</span>                              <span class="dim">â”‚</span>
<span class="dim">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="dim">â”‚</span>                                                                         <span class="dim">â”‚</span>
<span class="dim">â”‚</span>  <span class="yellow">ğŸ“¡ Data Pipeline</span>          <span class="green">ğŸ§  HMM Brain</span>           <span class="purple">âš–ï¸ Risk Manager</span>   <span class="dim">â”‚</span>
<span class="dim">â”‚</span>  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      <span class="dim">â”‚</span>
<span class="dim">â”‚</span>  â”‚ Binance API  â”‚â”€â”€â”€â”€â”€â”€â–¶ â”‚ GaussianHMM  â”‚â”€â”€â”€â”€â”€â–¶ â”‚ Conviction   â”‚      <span class="dim">â”‚</span>
<span class="dim">â”‚</span>  â”‚ OHLCV + OI   â”‚        â”‚ 4 States     â”‚       â”‚ Scoring 0-100â”‚      <span class="dim">â”‚</span>
<span class="dim">â”‚</span>  â”‚ 5m Â· 1h Â· 4h â”‚        â”‚ 8 Features   â”‚       â”‚ Lev 10x-35x  â”‚      <span class="dim">â”‚</span>
<span class="dim">â”‚</span>  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      <span class="dim">â”‚</span>
<span class="dim">â”‚</span>         â”‚                       â”‚                       â”‚              <span class="dim">â”‚</span>
<span class="dim">â”‚</span>         â–¼                       â–¼                       â–¼              <span class="dim">â”‚</span>
<span class="dim">â”‚</span>  <span class="accent">ğŸ“Š Feature Engine</span>       <span class="green">ğŸ¯ Regime Label</span>       <span class="red">ğŸ›¡ï¸ Trade Guard</span>      <span class="dim">â”‚</span>
<span class="dim">â”‚</span>  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      <span class="dim">â”‚</span>
<span class="dim">â”‚</span>  â”‚ 8 HMM feats  â”‚        â”‚ BULL â— BEAR  â”‚       â”‚ Vol Filter   â”‚      <span class="dim">â”‚</span>
<span class="dim">â”‚</span>  â”‚ VWAP Â· S/R   â”‚        â”‚ CHOP â— CRASH â”‚       â”‚ Kill Switch  â”‚      <span class="dim">â”‚</span>
<span class="dim">â”‚</span>  â”‚ OI Â· Funding â”‚        â”‚ Conviction % â”‚       â”‚ Max Loss -30%â”‚      <span class="dim">â”‚</span>
<span class="dim">â”‚</span>  â”‚ RSI Â· ATR    â”‚        â”‚ Multi-TF     â”‚       â”‚ Trailing SL  â”‚      <span class="dim">â”‚</span>
<span class="dim">â”‚</span>  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      <span class="dim">â”‚</span>
<span class="dim">â”‚</span>                                â”‚                                      <span class="dim">â”‚</span>
<span class="dim">â”‚</span>                                â–¼                                      <span class="dim">â”‚</span>
<span class="dim">â”‚</span>                     <span class="green">ğŸ“ Execution Engine</span>                              <span class="dim">â”‚</span>
<span class="dim">â”‚</span>                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              <span class="dim">â”‚</span>
<span class="dim">â”‚</span>                     â”‚ Paper / Live     â”‚                              <span class="dim">â”‚</span>
<span class="dim">â”‚</span>                     â”‚ Tradebook Track  â”‚                              <span class="dim">â”‚</span>
<span class="dim">â”‚</span>                     â”‚ Trailing SL/TP   â”‚                              <span class="dim">â”‚</span>
<span class="dim">â”‚</span>                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              <span class="dim">â”‚</span>
<span class="dim">â”‚</span>                                                                         <span class="dim">â”‚</span>
<span class="dim">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</pre>
                    </div>

                    <h3 class="sub-title">ğŸ“ File Structure</h3>
                    <table class="config-table">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Role</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="param-name">config.py</span></td>
                                <td>All settings, thresholds, and constants</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">main.py</span></td>
                                <td>Bot orchestrator â€” heartbeat loop, multi-coin scanning</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">data_pipeline.py</span></td>
                                <td>Binance API â€” OHLCV data fetching across timeframes</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">feature_engine.py</span></td>
                                <td>HMM features (log_return, volatility) + indicators (RSI, BB, ATR)</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">hmm_brain.py</span></td>
                                <td>Gaussian HMM â€” training, prediction, regime labelling</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">risk_manager.py</span></td>
                                <td>Dynamic leverage, position sizing, kill switch, ATR stops</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">execution_engine.py</span></td>
                                <td>Binance order placement + paper trade simulation</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">tradebook.py</span></td>
                                <td>Trade lifecycle â€” P&L tracking, trailing SL/TP, close logic</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">sideways_strategy.py</span></td>
                                <td>Mean reversion logic for CHOP regime (RSI/BB based)</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">coin_scanner.py</span></td>
                                <td>Fetches top N coins by 24h volume from Binance</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">backtest.py</span></td>
                                <td>Walk-forward backtesting engine with full SimTrade class</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- â•â•â• 2. STEP-BY-STEP WORKFLOW â•â•â• -->
            <div class="arch-section">
                <div class="arch-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <span class="emoji">ğŸ”„</span>
                    <h2>Step-by-Step Workflow</h2>
                    <span class="toggle">â–¼</span>
                </div>
                <div class="arch-section-body">

                    <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">
                        The bot runs a <strong>1-minute heartbeat</strong> with a full <strong>5-minute analysis
                            cycle</strong>.
                        Each cycle follows these steps for every coin:
                    </p>

                    <div class="step-flow">

                        <div class="step-box">
                            <div class="step-num">1</div>
                            <div class="step-content">
                                <h3>Coin Scanning</h3>
                                <p><code>coin_scanner.py</code> fetches the <strong>top 15 coins</strong> by 24h volume
                                    from Binance
                                    Futures.
                                    Re-scans every 4 analysis cycles (~1 hour). This ensures we always trade the most
                                    liquid
                                    markets. Max <strong>15 concurrent positions</strong> at 5% capital each (75% max
                                    deployed).</p>
                            </div>
                        </div>
                        <div class="step-connector"></div>

                        <div class="step-box">
                            <div class="step-num">2</div>
                            <div class="step-content">
                                <h3>Data Fetching (Multi-Timeframe)</h3>
                                <p><code>data_pipeline.py</code> pulls OHLCV candlestick data from Binance for each coin
                                    across
                                    <strong>three timeframes</strong>: 5m (execution timing), 1h (primary analysis), 4h
                                    (macro confirmation).
                                    Each fetch pulls the last 500 candles.
                                </p>
                            </div>
                        </div>
                        <div class="step-connector"></div>

                        <div class="step-box">
                            <div class="step-num">3</div>
                            <div class="step-content">
                                <h3>Feature Engineering</h3>
                                <p><code>feature_engine.py</code> computes <strong>8 HMM input features</strong> and
                                    additional technical indicators:</p>
                                <div class="logic-block">
                                    <h4>8 HMM Input Features (fed to GaussianHMM)</h4>
                                    <ul>
                                        <li><strong>log_return</strong> = <code>log(close / prev_close)</code> â€”
                                            directional momentum</li>
                                        <li><strong>volatility</strong> = <code>(high - low) / close</code> â€” intraday
                                            price range</li>
                                        <li><strong>volume_change</strong> = <code>log(volume / prev_volume)</code> â€”
                                            volume spikes signaling regime shifts</li>
                                        <li><strong>rsi_norm</strong> = <code>(RSI_14 - 50) / 50</code> â€” momentum
                                            context, range [-1, +1]</li>
                                        <li><strong>vwap_position</strong> = <code>(close - VWAP) / ATR</code> â€”
                                            distance from fair value</li>
                                        <li><strong>sr_position</strong> = position in S/R range [-1, +1] (support to
                                            resistance)</li>
                                        <li><strong>oi_change</strong> = <code>log(OI / prev_OI)</code> â€” open interest
                                            momentum</li>
                                        <li><strong>funding_norm</strong> = z-scored funding rate â€” crowding indicator
                                        </li>
                                    </ul>
                                </div>
                                <div class="logic-block purple">
                                    <h4>Additional Technical Indicators</h4>
                                    <ul>
                                        <li><strong>RSI</strong> (14) â€” overbought/oversold for mean reversion</li>
                                        <li><strong>Bollinger Bands</strong> (20, 2Ïƒ) â€” volatility squeeze detection
                                        </li>
                                        <li><strong>ATR</strong> (14) â€” used for SL/TP sizing and vol filter</li>
                                        <li><strong>VWAP</strong> (20-bar rolling) â€” volume-weighted fair value</li>
                                        <li><strong>Support / Resistance</strong> â€” swing high/low pivot levels</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="step-connector"></div>

                        <div class="step-box">
                            <div class="step-num">4</div>
                            <div class="step-content">
                                <h3>HMM Brain â€” Regime Classification</h3>
                                <p><code>hmm_brain.py</code> runs a Gaussian Hidden Markov Model with 4 states. It
                                    trains on
                                    the first 500 candles
                                    of 1h data, then predicts the current regime.</p>
                                <div class="badge-row">
                                    <span class="badge badge-bull">ğŸŸ¢ BULLISH</span>
                                    <span class="badge badge-bear">ğŸ”´ BEARISH</span>
                                    <span class="badge badge-chop">ğŸŸ¡ CHOP/SIDEWAYS</span>
                                    <span class="badge badge-crash">âš« CRASH/PANIC</span>
                                </div>
                                <div class="logic-block green">
                                    <h4>State Assignment Logic</h4>
                                    <ul>
                                        <li>Sort all 4 HMM states by their <strong>mean log-return</strong></li>
                                        <li>Highest return â†’ <strong>BULL</strong></li>
                                        <li>Lowest return â†’ <strong>CRASH</strong></li>
                                        <li>Two middle states: disambiguated by <strong>volatility</strong>
                                            â€” lower vol = <strong>CHOP</strong>, higher vol = <strong>BEAR</strong></li>
                                    </ul>
                                </div>
                                <div class="logic-block">
                                    <h4>Confidence Score</h4>
                                    <p>The confidence is the <strong>max posterior probability</strong> from the HMM's
                                        state
                                        prediction.
                                        A 0.90 confidence means the model is 90% sure of the current regime.</p>
                                </div>
                            </div>
                        </div>
                        <div class="step-connector"></div>

                        <div class="step-box">
                            <div class="step-num">5</div>
                            <div class="step-content">
                                <h3>Multi-Timeframe Confirmation</h3>
                                <p>A second HMM Brain runs on <strong>4h candles</strong> (macro timeframe). Conflicts
                                    are
                                    filtered out:</p>
                                <div class="logic-block red">
                                    <h4>Conflict Rules</h4>
                                    <ul>
                                        <li>1h = BULLISH but 4h = BEARISH â†’ <strong>SKIP</strong> (timeframes disagree)
                                        </li>
                                        <li>1h = BEARISH but 4h = BULLISH â†’ <strong>SKIP</strong></li>
                                        <li>4h = CRASH â†’ <strong>SKIP</strong> regardless of 1h signal</li>
                                        <li>Both agree â†’ <strong>HIGH CONVICTION</strong>, proceed to trade</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="step-connector"></div>

                        <div class="step-box">
                            <div class="step-num">6</div>
                            <div class="step-content">
                                <h3>Volatility Filter</h3>
                                <p>Before opening any trade, check <code>ATR / close_price</code> ratio:</p>
                                <div class="logic-block yellow">
                                    <h4>Filter Logic</h4>
                                    <ul>
                                        <li><strong>Below 0.5%</strong> â†’ <code>VOL_TOO_LOW</code> (coin is dead, no
                                            edge,
                                            fees eat profits)</li>
                                        <li><strong>Above 4.0%</strong> â†’ <code>VOL_TOO_HIGH</code> (too wild, SL gets
                                            spiked by wicks)</li>
                                        <li><strong>Between 0.5% â€“ 4.0%</strong> â†’ Sweet spot, proceed to trade</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="step-connector"></div>

                        <div class="step-box">
                            <div class="step-num">7</div>
                            <div class="step-content">
                                <h3>Conviction Scoring â†’ Dynamic Leverage</h3>
                                <p><code>risk_manager.py</code> computes a multi-factor <strong>conviction score
                                        (0-100)</strong> that drives continuous leverage from <strong>10Ã—â€“35Ã—</strong>:
                                </p>
                                <table class="config-table" style="margin:12px 0;">
                                    <thead>
                                        <tr>
                                            <th>Factor</th>
                                            <th>Weight</th>
                                            <th>What It Measures</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>HMM Confidence</td>
                                            <td class="param-value">30%</td>
                                            <td>Core model signal strength (â‰¥92% to score)</td>
                                        </tr>
                                        <tr>
                                            <td>BTC Macro Alignment</td>
                                            <td class="param-value">25%</td>
                                            <td>Does BTC regime agree with the trade?</td>
                                        </tr>
                                        <tr>
                                            <td>Funding Rate</td>
                                            <td class="param-value">15%</td>
                                            <td>Is the opposite side crowded? (squeeze potential)</td>
                                        </tr>
                                        <tr>
                                            <td>S/R + VWAP Position</td>
                                            <td class="param-value">15%</td>
                                            <td>Are we entering at a structurally favorable level?</td>
                                        </tr>
                                        <tr>
                                            <td>OI Momentum</td>
                                            <td class="param-value">10%</td>
                                            <td>Is smart money building our direction?</td>
                                        </tr>
                                        <tr>
                                            <td>Volatility Regime</td>
                                            <td class="param-value">5%</td>
                                            <td>Is vol in the tradeable sweet spot?</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="logic-block green">
                                    <h4>Score â†’ Leverage Mapping</h4>
                                    <ul>
                                        <li>Conviction <strong>&lt; 40</strong> â†’ <strong>SKIP</strong> (no trade)</li>
                                        <li>Conviction <strong>40</strong> â†’ <strong>10Ã—</strong> leverage (minimum)
                                        </li>
                                        <li>Conviction <strong>70</strong> â†’ <strong>~22Ã—</strong> leverage (mid-range)
                                        </li>
                                        <li>Conviction <strong>100</strong> â†’ <strong>35Ã—</strong> leverage (maximum)
                                        </li>
                                        <li>Formula: <code>leverage = 10 + (score - 40) / 60 Ã— 25</code></li>
                                    </ul>
                                </div>
                                <div class="logic-block red">
                                    <h4>CRASH & Chop Regimes</h4>
                                    <ul>
                                        <li><strong>CRASH</strong> on either timeframe â†’ <strong>0Ã—</strong> (skip â€”
                                            capital preservation)</li>
                                        <li><strong>CHOP</strong> â†’ Sideways strategy at reduced 10Ã— leverage (mean
                                            reversion)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="step-connector"></div>

                        <div class="step-box">
                            <div class="step-num">8</div>
                            <div class="step-content">
                                <h3>Trade Direction</h3>
                                <div class="logic-block green">
                                    <h4>Trend Regimes</h4>
                                    <ul>
                                        <li><strong>BULLISH</strong> â†’ Open <strong>LONG</strong></li>
                                        <li><strong>BEARISH</strong> â†’ Open <strong>SHORT</strong></li>
                                    </ul>
                                </div>
                                <div class="logic-block yellow">
                                    <h4>Chop Regime (Mean Reversion)</h4>
                                    <ul>
                                        <li>RSI > 70 â†’ Open <strong>SHORT</strong> (overbought reversal)</li>
                                        <li>RSI < 30 â†’ Open <strong>LONG</strong> (oversold bounce)</li>
                                        <li>RSI 30â€“70 â†’ <strong>SKIP</strong> (no edge)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="step-connector"></div>

                        <div class="step-box">
                            <div class="step-num">9</div>
                            <div class="step-content">
                                <h3>15m Momentum Filter</h3>
                                <p>For trend trades, fetches 15-minute data and checks momentum alignment:</p>
                                <div class="logic-block">
                                    <h4>Filter Logic</h4>
                                    <ul>
                                        <li>Going <strong>LONG</strong> but price dropped over last 5 candles (75m) â†’
                                            <strong>SKIP</strong>
                                        </li>
                                        <li>Going <strong>SHORT</strong> but price rose over last 5 candles (75m) â†’
                                            <strong>SKIP</strong>
                                        </li>
                                        <li>Prevents entering against short-term momentum</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="step-connector"></div>

                        <div class="step-box">
                            <div class="step-num">10</div>
                            <div class="step-content">
                                <h3>Position Sizing & ATR-Based SL/TP</h3>
                                <p><code>risk_manager.py</code> calculates position size using the 2% rule, then places
                                    ATR-based stops:</p>
                                <div class="logic-block purple">
                                    <h4>Position Size Formula</h4>
                                    <ul>
                                        <li><code>risk_amount = balance Ã— 2%</code></li>
                                        <li><code>stop_distance = ATR Ã— 1.5</code></li>
                                        <li><code>quantity = risk_amount / stop_distance</code></li>
                                    </ul>
                                </div>
                                <div class="logic-block">
                                    <h4>SL/TP Placement</h4>
                                    <ul>
                                        <li><strong>Stop Loss</strong> = entry Â± (ATR Ã— 1.5) â€” 1.5Ã— ATR distance</li>
                                        <li><strong>Take Profit</strong> = entry Â± (ATR Ã— 3.0) â€” 1:2 risk-reward ratio
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="step-connector"></div>

                        <div class="step-box">
                            <div class="step-num">11</div>
                            <div class="step-content">
                                <h3>Trailing SL / TP Management</h3>
                                <p><code>tradebook.py</code> manages active trades and implements trailing logic:</p>
                                <div class="logic-block green">
                                    <h4>Trailing Stop Loss</h4>
                                    <ul>
                                        <li><strong>Activation:</strong> After price moves <strong>1Ã— ATR</strong> in
                                            favor
                                            of the trade</li>
                                        <li><strong>Trail Distance:</strong> SL follows <strong>1Ã— ATR</strong> behind
                                            the
                                            peak price</li>
                                        <li>SL only <strong>tightens</strong> (moves in your favor), never loosens</li>
                                        <li>Tracks the <strong>peak price</strong> (highest high for longs, lowest low
                                            for
                                            shorts)</li>
                                    </ul>
                                </div>
                                <div class="logic-block purple">
                                    <h4>Trailing Take Profit</h4>
                                    <ul>
                                        <li><strong>Activation:</strong> When price reaches <strong>75%</strong> of the
                                            TP
                                            distance</li>
                                        <li><strong>Extension:</strong> TP extends by <strong>1.5Ã— ATR</strong> each
                                            time
                                        </li>
                                        <li><strong>Max Extensions:</strong> 3 (prevents runaway targets)</li>
                                        <li>Allows profits to run while maintaining exits</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="step-connector"></div>

                        <div class="step-box">
                            <div class="step-num">12</div>
                            <div class="step-content">
                                <h3>Trade Exit (SL/TP Only)</h3>
                                <p>Trades exit ONLY via price levels â€” regime changes do NOT trigger exits (backtest
                                    confirmed this improves returns):</p>
                                <div class="logic-block red">
                                    <h4>Exit Triggers</h4>
                                    <ul>
                                        <li><strong>STOP_LOSS</strong> / <strong>TRAILING_SL</strong> â€” SL level hit
                                        </li>
                                        <li><strong>TAKE_PROFIT</strong> / <strong>TRAILING_TP</strong> â€” TP level hit
                                        </li>
                                        <li><strong>MAX_LOSS</strong> â€” Unrealized P&L hits -30%</li>
                                        <li><strong>KILL_SWITCH</strong> â€” Portfolio down 10%+ in 24h, all trades closed
                                        </li>
                                    </ul>
                                </div>
                                <div class="logic-block green">
                                    <h4>Why No Regime-Change Exits?</h4>
                                    <p>Backtest analysis showed regime exits <strong>hurt returns</strong> because the
                                        HMM
                                        anticipates moves, and double fees (exit + re-entry) eat into profits. The
                                        ATR-based
                                        SL/TP system handles exits more efficiently.</p>
                                </div>
                            </div>
                        </div>

                    </div> <!-- /step-flow -->
                </div>
            </div>

            <!-- â•â•â• HMM INTERACTIVE SIMULATION â•â•â• -->
            <div class="arch-section">
                <div class="arch-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <span class="emoji">ğŸ§ </span>
                    <h2>How HMM Works â€” Interactive Simulation</h2>
                </div>
                <div class="arch-section-body">
                    <div class="logic-block blue" style="margin-bottom:20px;">
                        <h4>What is a Hidden Markov Model?</h4>
                        <p style="margin:8px 0;">An HMM is a statistical model where the system transitions between
                            <strong>hidden states</strong> (market regimes) that we cannot observe directly. Instead, we
                            observe <strong>emissions</strong> (price returns, volatility) and use them to
                            <em>infer</em>
                            the most likely hidden state sequence.
                        </p>
                    </div>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                        <div class="logic-block green">
                            <h4>ğŸ”´ Hidden States (Regimes)</h4>
                            <ul style="margin:6px 0;">
                                <li><span style="color:#4ade80;">â—</span> <strong>BULLISH</strong> â€” Uptrend, positive
                                    returns</li>
                                <li><span style="color:#f87171;">â—</span> <strong>BEARISH</strong> â€” Downtrend, negative
                                    returns</li>
                                <li><span style="color:#facc15;">â—</span> <strong>SIDEWAYS</strong> â€” Low volatility
                                    chop
                                </li>
                                <li><span style="color:#f472b6;">â—</span> <strong>CRASH</strong> â€” High vol, sharp drops
                                </li>
                            </ul>
                        </div>
                        <div class="logic-block blue">
                            <h4>ğŸ“Š Observable Emissions</h4>
                            <ul style="margin:6px 0;">
                                <li>Log returns (price change %)</li>
                                <li>Volatility (rolling std dev)</li>
                                <li>Volume profile changes</li>
                                <li>ATR (Average True Range)</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Transition Matrix Visualization -->
                    <div class="logic-block"
                        style="background:rgba(99,102,241,0.08);border-color:#6366f1;margin-bottom:20px;">
                        <h4>Transition Probability Matrix</h4>
                        <p style="margin:6px 0 12px;font-size:13px;color:var(--text-secondary);">Probability of moving
                            between regimes. Rows = FROM, Columns = TO.</p>
                        <table class="config-table" style="font-size:13px;">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th style="color:#4ade80;">BULL</th>
                                    <th style="color:#f87171;">BEAR</th>
                                    <th style="color:#facc15;">SIDE</th>
                                    <th style="color:#f472b6;">CRASH</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="color:#4ade80;font-weight:600;">BULL</td>
                                    <td style="background:rgba(74,222,128,0.15);">0.85</td>
                                    <td>0.05</td>
                                    <td>0.08</td>
                                    <td>0.02</td>
                                </tr>
                                <tr>
                                    <td style="color:#f87171;font-weight:600;">BEAR</td>
                                    <td>0.05</td>
                                    <td style="background:rgba(248,113,113,0.15);">0.80</td>
                                    <td>0.10</td>
                                    <td>0.05</td>
                                </tr>
                                <tr>
                                    <td style="color:#facc15;font-weight:600;">SIDE</td>
                                    <td>0.15</td>
                                    <td>0.15</td>
                                    <td style="background:rgba(250,204,21,0.15);">0.65</td>
                                    <td>0.05</td>
                                </tr>
                                <tr>
                                    <td style="color:#f472b6;font-weight:600;">CRASH</td>
                                    <td>0.10</td>
                                    <td>0.30</td>
                                    <td>0.10</td>
                                    <td style="background:rgba(244,114,182,0.15);">0.50</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Canvas Simulation -->
                    <div style="margin-bottom:16px;">
                        <h4 style="margin-bottom:10px;">ğŸ¬ Live Regime Detection Simulation</h4>
                        <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;">Click "Run Simulation"
                            to
                            generate random price data and watch the HMM identify market regimes in real-time.</p>
                        <div style="display:flex;gap:10px;margin-bottom:12px;">
                            <button onclick="runHmmSimulation()"
                                style="padding:8px 20px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;">â–¶
                                Run Simulation</button>
                            <button onclick="resetHmmSimulation()"
                                style="padding:8px 16px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:var(--text-secondary);border-radius:8px;cursor:pointer;font-size:14px;">â†»
                                Reset</button>
                        </div>
                        <canvas id="hmmCanvas" width="800" height="280"
                            style="width:100%;border-radius:12px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.3);"></canvas>
                        <div id="hmmLegend"
                            style="display:flex;gap:16px;margin-top:8px;font-size:12px;color:var(--text-secondary);">
                            <span><span style="color:#4ade80;">â”â”</span> Bullish</span>
                            <span><span style="color:#f87171;">â”â”</span> Bearish</span>
                            <span><span style="color:#facc15;">â”â”</span> Sideways</span>
                            <span><span style="color:#f472b6;">â”â”</span> Crash</span>
                            <span style="margin-left:auto;" id="hmmSimStatus">Ready</span>
                        </div>
                    </div>

                    <!-- Viterbi Decoding Steps -->
                    <div class="logic-block green" style="margin-top:16px;">
                        <h4>ğŸ§® How Viterbi Decoding Works (Step-by-Step)</h4>
                        <ol style="margin:8px 0;line-height:1.8;">
                            <li><strong>Initialize:</strong> Start with initial state probabilities (Ï€)</li>
                            <li><strong>Observe:</strong> At each timestep, observe price return & volatility</li>
                            <li><strong>Forward pass:</strong> For each state, compute max probability of arriving there
                            </li>
                            <li><strong>Score:</strong> P(observation | state) Ã— max(P(previous state) Ã— P(transition))
                            </li>
                            <li><strong>Backtrace:</strong> Walk backwards through the path to find the most likely
                                state
                                sequence</li>
                            <li><strong>Output:</strong> Each candle gets a regime label (BULL/BEAR/SIDE/CRASH)</li>
                        </ol>
                    </div>
                </div>
            </div>

        </div><!-- /tab-architecture -->

        <!-- â•â•â• TAB 2: CONFIGURATION â•â•â• -->
        <div class="tab-pane" id="tab-configuration">

            <!-- â•â•â• REGIME ENGINE DEFAULTS â•â•â• -->
            <div class="arch-section">
                <div class="arch-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <span class="emoji">ğŸ›ï¸</span>
                    <h2>Regime Engine Defaults</h2>
                </div>
                <div class="arch-section-body">
                    <p style="color:var(--text-secondary);margin-bottom:16px;">Select a risk preset to automatically
                        configure leverage, confidence thresholds, stop-loss limits, and volatility filters. Changes are
                        applied to <code>config.py</code> and take effect on the next bot cycle.</p>

                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px;">
                        <!-- Conservative -->
                        <div class="preset-card" id="presetConservative" onclick="applyPreset('conservative')"
                            style="cursor:pointer;padding:20px;border-radius:12px;border:2px solid rgba(74,222,128,0.2);background:rgba(74,222,128,0.04);transition:all 0.3s;">
                            <div style="font-size:28px;margin-bottom:8px;">ğŸ›¡ï¸</div>
                            <h3 style="margin:0 0 6px;color:#4ade80;">Conservative</h3>
                            <p style="font-size:12px;color:var(--text-secondary);margin:0 0 12px;">Low risk, tight
                                stops,
                                lower leverage</p>
                            <ul
                                style="font-size:12px;color:var(--text-tertiary);list-style:none;padding:0;margin:0;line-height:1.7;">
                                <li>Risk: <strong>1%</strong> per trade</li>
                                <li>Leverage: <strong>10-20Ã—</strong></li>
                                <li>Max Loss: <strong>-20%</strong></li>
                                <li>Min Confidence: <strong>95%</strong></li>
                            </ul>
                        </div>
                        <!-- Balanced -->
                        <div class="preset-card" id="presetBalanced" onclick="applyPreset('balanced')"
                            style="cursor:pointer;padding:20px;border-radius:12px;border:2px solid rgba(99,102,241,0.3);background:rgba(99,102,241,0.06);transition:all 0.3s;">
                            <div style="font-size:28px;margin-bottom:8px;">âš–ï¸</div>
                            <h3 style="margin:0 0 6px;color:#818cf8;">Balanced</h3>
                            <p style="font-size:12px;color:var(--text-secondary);margin:0 0 12px;">Default settings,
                                moderate risk/reward</p>
                            <ul
                                style="font-size:12px;color:var(--text-tertiary);list-style:none;padding:0;margin:0;line-height:1.7;">
                                <li>Risk: <strong>2%</strong> per trade</li>
                                <li>Leverage: <strong>10-35Ã—</strong></li>
                                <li>Max Loss: <strong>-30%</strong></li>
                                <li>Min Confidence: <strong>85%</strong></li>
                            </ul>
                        </div>
                        <!-- Aggressive -->
                        <div class="preset-card" id="presetAggressive" onclick="applyPreset('aggressive')"
                            style="cursor:pointer;padding:20px;border-radius:12px;border:2px solid rgba(248,113,113,0.2);background:rgba(248,113,113,0.04);transition:all 0.3s;">
                            <div style="font-size:28px;margin-bottom:8px;">ğŸ”¥</div>
                            <h3 style="margin:0 0 6px;color:#f87171;">Aggressive</h3>
                            <p style="font-size:12px;color:var(--text-secondary);margin:0 0 12px;">Higher risk, wider
                                stops,
                                max leverage</p>
                            <ul
                                style="font-size:12px;color:var(--text-tertiary);list-style:none;padding:0;margin:0;line-height:1.7;">
                                <li>Risk: <strong>3%</strong> per trade</li>
                                <li>Leverage: <strong>15-35Ã—</strong></li>
                                <li>Max Loss: <strong>-30%</strong></li>
                                <li>Min Confidence: <strong>80%</strong></li>
                            </ul>
                        </div>
                    </div>

                    <div id="presetStatus"
                        style="display:none;padding:12px 16px;border-radius:8px;font-size:13px;margin-bottom:16px;">
                    </div>

                    <!-- Details comparison table -->
                    <div style="overflow-x:auto;">
                        <table class="config-table" style="font-size:13px;">
                            <thead>
                                <tr>
                                    <th>Parameter</th>
                                    <th style="color:#4ade80;">Conservative</th>
                                    <th style="color:#818cf8;">Balanced</th>
                                    <th style="color:#f87171;">Aggressive</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>RISK_PER_TRADE</td>
                                    <td>1%</td>
                                    <td>2%</td>
                                    <td>3%</td>
                                </tr>
                                <tr>
                                    <td>LEVERAGE (Low/Med/High)</td>
                                    <td>10 / 15 / 20</td>
                                    <td>10 / 20 / 35</td>
                                    <td>15 / 25 / 35</td>
                                </tr>
                                <tr>
                                    <td>MAX_LOSS_PER_TRADE_PCT</td>
                                    <td>-20%</td>
                                    <td>-30%</td>
                                    <td>-30%</td>
                                </tr>
                                <tr>
                                    <td>CONFIDENCE (Low/Med/High)</td>
                                    <td>90 / 93 / 95</td>
                                    <td>85 / 91 / 95</td>
                                    <td>80 / 88 / 93</td>
                                </tr>
                                <tr>
                                    <td>VOL_ATR_PCT (Min/Max)</td>
                                    <td>0.8% / 3%</td>
                                    <td>0.5% / 4%</td>
                                    <td>0.3% / 6%</td>
                                </tr>
                                <tr>
                                    <td>Trailing SL/TP</td>
                                    <td>âœ… Enabled</td>
                                    <td>âœ… Enabled</td>
                                    <td>âœ… Enabled</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div><!-- /tab-configuration -->

        <!-- â•â•â• TAB 3: INTEGRATIONS â•â•â• -->
        <div class="tab-pane" id="tab-integrations">

            <!-- â•â•â• TELEGRAM INTEGRATION â•â•â• -->
            <div class="arch-section">
                <div class="arch-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <span class="emoji">ğŸ“±</span>
                    <h2>Telegram Integration <span id="tgStatusBadge"
                            style="font-size:12px;color:var(--text-tertiary);font-weight:400;margin-left:8px;">Loading...</span>
                    </h2>
                </div>
                <div class="arch-section-body">
                    <p style="color:var(--text-secondary);margin-bottom:16px;">Receive real-time trade alerts, risk
                        warnings, and daily summaries directly on your phone via Telegram.</p>

                    <!-- Setup Steps -->
                    <div class="logic-block blue" style="margin-bottom:20px;">
                        <h4>Quick Setup (2 minutes)</h4>
                        <ol style="margin:8px 0;line-height:2;">
                            <li>Open Telegram and search for your bot (token is already configured)</li>
                            <li>Send <code>/start</code> to the bot</li>
                            <li>Click "ğŸ” Detect Chat ID" below to auto-fill your chat ID</li>
                            <li>Click "ğŸ§ª Test" to verify the connection</li>
                        </ol>
                    </div>

                    <!-- Config Form -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
                        <div>
                            <label
                                style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px;">Bot
                                Token</label>
                            <input type="text" id="tgBotToken" readonly
                                style="width:100%;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.04);color:var(--text-secondary);font-family:monospace;font-size:13px;"
                                placeholder="Configured in .env" />
                        </div>
                        <div>
                            <label
                                style="font-size:13px;color:var(--text-secondary);display:block;margin-bottom:6px;">Chat
                                ID</label>
                            <div style="display:flex;gap:8px;">
                                <input type="text" id="tgChatId"
                                    style="flex:1;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.04);color:var(--text-primary);font-family:monospace;font-size:13px;"
                                    placeholder="Click detect â†’" />
                                <button onclick="detectChatId()"
                                    style="padding:8px 14px;background:rgba(99,102,241,0.15);border:1px solid rgba(99,102,241,0.3);color:#818cf8;border-radius:8px;cursor:pointer;font-size:13px;white-space:nowrap;">ğŸ”
                                    Detect</button>
                            </div>
                        </div>
                    </div>

                    <!-- Notification Toggles -->
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;">
                        <label class="toggle-card"
                            style="display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);cursor:pointer;">
                            <input type="checkbox" id="tgEnabled" onchange="saveTelegramConfig()"
                                style="accent-color:var(--accent);width:16px;height:16px;" />
                            <div>
                                <div style="font-size:13px;font-weight:600;">Enabled</div>
                                <div style="font-size:11px;color:var(--text-tertiary);">Master switch</div>
                            </div>
                        </label>
                        <label class="toggle-card"
                            style="display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);cursor:pointer;">
                            <input type="checkbox" id="tgNotifyTrades" onchange="saveTelegramConfig()"
                                style="accent-color:var(--accent);width:16px;height:16px;" />
                            <div>
                                <div style="font-size:13px;font-weight:600;">Trades</div>
                                <div style="font-size:11px;color:var(--text-tertiary);">Open/close</div>
                            </div>
                        </label>
                        <label class="toggle-card"
                            style="display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);cursor:pointer;">
                            <input type="checkbox" id="tgNotifyAlerts" onchange="saveTelegramConfig()"
                                style="accent-color:var(--accent);width:16px;height:16px;" />
                            <div>
                                <div style="font-size:13px;font-weight:600;">Alerts</div>
                                <div style="font-size:11px;color:var(--text-tertiary);">Kill switch, MAX_LOSS</div>
                            </div>
                        </label>
                        <label class="toggle-card"
                            style="display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);cursor:pointer;">
                            <input type="checkbox" id="tgNotifySummary" onchange="saveTelegramConfig()"
                                style="accent-color:var(--accent);width:16px;height:16px;" />
                            <div>
                                <div style="font-size:13px;font-weight:600;">Summary</div>
                                <div style="font-size:11px;color:var(--text-tertiary);">Daily P&L</div>
                            </div>
                        </label>
                    </div>

                    <!-- Pause / Resume Button -->
                    <div style="margin-bottom:20px;">
                        <button id="tgPauseBtn" onclick="toggleTelegramPause()"
                            style="width:100%;padding:14px 24px;border-radius:12px;border:2px solid rgba(239,68,68,0.3);background:rgba(239,68,68,0.08);color:#f87171;font-size:15px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all 0.3s;">
                            <span id="tgPauseIcon" style="font-size:20px;">â¸</span>
                            <span id="tgPauseLabel">Pause All Notifications</span>
                        </button>
                        <p id="tgPauseHint"
                            style="text-align:center;font-size:12px;color:var(--text-tertiary);margin-top:6px;">
                            Instantly stops all Telegram messages. Click again to resume.</p>
                    </div>

                    <!-- Action buttons -->
                    <div style="display:flex;gap:10px;align-items:center;">
                        <button onclick="saveTelegramChatId()"
                            style="padding:8px 20px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px;">ğŸ’¾
                            Save Chat ID</button>
                        <button onclick="testTelegram()"
                            style="padding:8px 20px;background:rgba(74,222,128,0.15);border:1px solid rgba(74,222,128,0.3);color:#4ade80;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;">ğŸ§ª
                            Send Test</button>
                        <span id="tgActionStatus"
                            style="font-size:13px;color:var(--text-tertiary);margin-left:8px;"></span>
                    </div>
                </div>
            </div>

            <!-- â•â•â• 3. CONFIGURATION REFERENCE â•â•â• -->
            <div class="arch-section">
                <div class="arch-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <span class="emoji">âš™ï¸</span>
                    <h2>Configuration Reference <span
                            style="font-size:12px;color:var(--text-tertiary);font-weight:400;margin-left:8px;"
                            id="configStatus">Loading live values...</span></h2>
                    <span class="toggle">â–¼</span>
                </div>
                <div class="arch-section-body">

                    <h3 class="sub-title">ğŸ§  HMM Brain</h3>
                    <table class="config-table">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Value</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="param-name">HMM_N_STATES</span></td>
                                <td class="param-value" data-cfg="HMM_N_STATES">4</td>
                                <td>Number of hidden states (Bull, Bear, Chop, Crash)</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">HMM_COVARIANCE</span></td>
                                <td class="param-value" data-cfg="HMM_COVARIANCE">diag</td>
                                <td>Covariance type for Gaussian emissions</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">HMM_ITERATIONS</span></td>
                                <td class="param-value" data-cfg="HMM_ITERATIONS">100</td>
                                <td>Max EM iterations during training</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">HMM_LOOKBACK</span></td>
                                <td class="param-value" data-cfg="HMM_LOOKBACK">500</td>
                                <td>Candles used for training</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">HMM_RETRAIN_HOURS</span></td>
                                <td class="param-value" data-cfg="HMM_RETRAIN_HOURS">24</td>
                                <td>Retrain model every N hours</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 class="sub-title">ğŸ“Š Leverage & Confidence</h3>
                    <table class="config-table">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Value</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="param-name">LEVERAGE_HIGH</span></td>
                                <td class="param-value" data-cfg="LEVERAGE_HIGH" data-fmt="x">35Ã—</td>
                                <td>Confidence â‰¥ 95% trend trades</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">LEVERAGE_MODERATE</span></td>
                                <td class="param-value" data-cfg="LEVERAGE_MODERATE" data-fmt="x">20Ã—</td>
                                <td>Confidence 91â€“95%</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">LEVERAGE_LOW</span></td>
                                <td class="param-value" data-cfg="LEVERAGE_LOW" data-fmt="x">10Ã—</td>
                                <td>Confidence 85â€“91% / CHOP regime</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">CONFIDENCE_HIGH</span></td>
                                <td class="param-value" data-cfg="CONFIDENCE_HIGH" data-fmt="pct">95%</td>
                                <td>Threshold for 35Ã— leverage</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">CONFIDENCE_MEDIUM</span></td>
                                <td class="param-value" data-cfg="CONFIDENCE_MEDIUM" data-fmt="pct">91%</td>
                                <td>Threshold for 25Ã— leverage</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">CONFIDENCE_LOW</span></td>
                                <td class="param-value" data-cfg="CONFIDENCE_LOW" data-fmt="pct">85%</td>
                                <td>Minimum for any trade (DO NOT DEPLOY below)</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 class="sub-title">ğŸ›¡ï¸ Risk Management</h3>
                    <table class="config-table">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Value</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="param-name">RISK_PER_TRADE</span></td>
                                <td class="param-value" data-cfg="RISK_PER_TRADE" data-fmt="pct">2%</td>
                                <td>Max balance risk per SL hit</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">MAX_LOSS_PER_TRADE_PCT</span></td>
                                <td class="param-value" data-cfg="MAX_LOSS_PER_TRADE_PCT" data-fmt="pctval">-30%</td>
                                <td>Auto-exit if unrealized P&L hits this</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">KILL_SWITCH_DRAWDOWN</span></td>
                                <td class="param-value" data-cfg="KILL_SWITCH_DRAWDOWN" data-fmt="pct">10%</td>
                                <td>Pause bot if drawdown in 24h</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">ATR_SL_MULTIPLIER</span></td>
                                <td class="param-value" data-cfg="ATR_SL_MULTIPLIER" data-fmt="x">1.5Ã—</td>
                                <td>SL = ATR Ã— this multiplier</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">ATR_TP_MULTIPLIER</span></td>
                                <td class="param-value" data-cfg="ATR_TP_MULTIPLIER" data-fmt="x">3.0Ã—</td>
                                <td>TP = ATR Ã— this multiplier</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">SLIPPAGE_BUFFER</span></td>
                                <td class="param-value" data-cfg="SLIPPAGE_BUFFER" data-fmt="pct">0.05%</td>
                                <td>Slippage estimate per leg</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">MIN_HOLD_MINUTES</span></td>
                                <td class="param-value" data-cfg="MIN_HOLD_MINUTES">30</td>
                                <td>Min hold time (regime exits disabled â€” SL/TP only)</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">MARGIN_TYPE</span></td>
                                <td class="param-value" data-cfg="MARGIN_TYPE">ISOLATED</td>
                                <td>Never CROSS for high leverage</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">PAPER_MAX_CAPITAL</span></td>
                                <td class="param-value" data-cfg="PAPER_MAX_CAPITAL" data-fmt="$">$1,500</td>
                                <td>Total paper portfolio (15 slots Ã— $100)</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 class="sub-title">ğŸ”„ Trailing SL / TP</h3>
                    <table class="config-table">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Value</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="param-name">TRAILING_SL_ENABLED</span></td>
                                <td class="param-value" data-cfg="TRAILING_SL_ENABLED" data-fmt="bool">true</td>
                                <td>Enable/disable trailing stop loss</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">TRAILING_SL_ACTIVATION_ATR</span></td>
                                <td class="param-value" data-cfg="TRAILING_SL_ACTIVATION_ATR" data-fmt="x">1.0Ã—</td>
                                <td>Activate after price moves 1Ã—ATR in favor</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">TRAILING_SL_DISTANCE_ATR</span></td>
                                <td class="param-value" data-cfg="TRAILING_SL_DISTANCE_ATR" data-fmt="x">1.0Ã—</td>
                                <td>SL stays 1Ã—ATR behind peak</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">TRAILING_TP_ENABLED</span></td>
                                <td class="param-value" data-cfg="TRAILING_TP_ENABLED" data-fmt="bool">true</td>
                                <td>Enable/disable trailing take profit</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">TRAILING_TP_ACTIVATION_PCT</span></td>
                                <td class="param-value" data-cfg="TRAILING_TP_ACTIVATION_PCT" data-fmt="pct">75%</td>
                                <td>Extend TP at 75% of distance</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">TRAILING_TP_EXTENSION_ATR</span></td>
                                <td class="param-value" data-cfg="TRAILING_TP_EXTENSION_ATR" data-fmt="x">1.5Ã—</td>
                                <td>Extend TP by 1.5Ã—ATR each time</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">TRAILING_TP_MAX_EXTENSIONS</span></td>
                                <td class="param-value" data-cfg="TRAILING_TP_MAX_EXTENSIONS">3</td>
                                <td>Maximum TP extensions</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 class="sub-title">ğŸŒŠ Volatility Filter</h3>
                    <table class="config-table">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Value</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="param-name">VOL_FILTER_ENABLED</span></td>
                                <td class="param-value" data-cfg="VOL_FILTER_ENABLED" data-fmt="bool">true</td>
                                <td>Enable/disable volatility band filter</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">VOL_MIN_ATR_PCT</span></td>
                                <td class="param-value" data-cfg="VOL_MIN_ATR_PCT" data-fmt="pct">0.5%</td>
                                <td>Skip if ATR/price below this (dead coin)</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">VOL_MAX_ATR_PCT</span></td>
                                <td class="param-value" data-cfg="VOL_MAX_ATR_PCT" data-fmt="pct">4.0%</td>
                                <td>Skip if ATR/price above this (too wild)</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 class="sub-title">ğŸ’° Fees</h3>
                    <table class="config-table">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Value</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="param-name">TAKER_FEE</span></td>
                                <td class="param-value" data-cfg="TAKER_FEE" data-fmt="pct">0.05%</td>
                                <td>Binance Futures taker fee per leg (0.1% round trip)</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">MAKER_FEE</span></td>
                                <td class="param-value" data-cfg="MAKER_FEE" data-fmt="pct">0.02%</td>
                                <td>Binance Futures maker fee per leg</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 class="sub-title">ğŸ“Š Sideways Strategy</h3>
                    <table class="config-table">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Value</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="param-name">BB_LENGTH</span></td>
                                <td class="param-value" data-cfg="BB_LENGTH">20</td>
                                <td>Bollinger Band period</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">BB_STD</span></td>
                                <td class="param-value" data-cfg="BB_STD">2.0</td>
                                <td>Bollinger Band standard deviations</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">RSI_LENGTH</span></td>
                                <td class="param-value" data-cfg="RSI_LENGTH">14</td>
                                <td>RSI period</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">RSI_OVERSOLD</span></td>
                                <td class="param-value" data-cfg="RSI_OVERSOLD">35</td>
                                <td>RSI oversold threshold</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">RSI_OVERBOUGHT</span></td>
                                <td class="param-value" data-cfg="RSI_OVERBOUGHT">65</td>
                                <td>RSI overbought threshold</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">SIDEWAYS_POSITION_REDUCTION</span></td>
                                <td class="param-value" data-cfg="SIDEWAYS_POSITION_REDUCTION" data-fmt="pct">30%</td>
                                <td>Position size reduction in chop</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 class="sub-title">ğŸ¤– Bot Timing & Multi-Coin</h3>
                    <table class="config-table">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Value</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="param-name">LOOP_INTERVAL_SECONDS</span></td>
                                <td class="param-value" data-cfg="LOOP_INTERVAL_SECONDS" data-fmt="s">60s</td>
                                <td>Heartbeat interval (checks commands, updates state)</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">ANALYSIS_INTERVAL_SECONDS</span></td>
                                <td class="param-value" data-cfg="ANALYSIS_INTERVAL_SECONDS" data-fmt="s">900s</td>
                                <td>Full analysis cycle (HMM scan + trade)</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">ERROR_RETRY_SECONDS</span></td>
                                <td class="param-value" data-cfg="ERROR_RETRY_SECONDS" data-fmt="s">60s</td>
                                <td>Retry delay after error</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">MAX_CONCURRENT_POSITIONS</span></td>
                                <td class="param-value" data-cfg="MAX_CONCURRENT_POSITIONS">15</td>
                                <td>Max simultaneous open positions</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">TOP_COINS_LIMIT</span></td>
                                <td class="param-value" data-cfg="TOP_COINS_LIMIT">15</td>
                                <td>Number of coins to scan</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">CAPITAL_PER_COIN_PCT</span></td>
                                <td class="param-value" data-cfg="CAPITAL_PER_COIN_PCT" data-fmt="pct">3%</td>
                                <td>Portfolio allocation per coin</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">SCAN_INTERVAL_CYCLES</span></td>
                                <td class="param-value" data-cfg="SCAN_INTERVAL_CYCLES">4</td>
                                <td>Re-scan top coins every N cycles</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">MULTI_COIN_MODE</span></td>
                                <td class="param-value" data-cfg="MULTI_COIN_MODE" data-fmt="bool">true</td>
                                <td>Enable multi-coin scanning</td>
                            </tr>
                        </tbody>
                    </table>

                </div>
            </div>

            <!-- â•â•â• 4. Regime Decision Tree â•â•â• -->
            <div class="arch-section">
                <div class="arch-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <span class="emoji">ğŸŒ³</span>
                    <h2>Regime Decision Tree</h2>
                    <span class="toggle">â–¼</span>
                </div>
                <div class="arch-section-body">
                    <div class="arch-diagram">
                        <pre>
                         <span class="accent">HMM Prediction</span>
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼               â–¼               â–¼
         <span class="red">CRASH</span>          <span class="yellow">CHOP</span>       <span class="green">BULL</span> / <span class="red">BEAR</span>
              â”‚               â”‚               â”‚
              â–¼               â–¼               â–¼
        <span class="dim">âœ— NO TRADE</span>     Check RSI      4h Confirmation
                              â”‚               â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”     Match?
                     â–¼        â–¼        â–¼      â”‚
                  RSI<30   30-70    RSI>70    â”Œâ”€â”´â”€â”
                     â”‚        â”‚        â”‚      â–¼   â–¼
                   <span class="green">LONG</span>    <span class="dim">SKIP</span>    <span class="red">SHORT</span>  <span class="green">YES</span>  <span class="dim">NOâ†’SKIP</span>
                     â”‚                 â”‚      â”‚
                     â–¼                 â–¼      â–¼
                   15Ã—              15Ã—    Vol Filter
                                           â”‚
                                      â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”
                                      â–¼    â–¼    â–¼
                                    <span class="dim">&lt;0.5%</span> <span class="green">OK</span>  <span class="dim">&gt;4%</span>
                                    <span class="dim">SKIP</span>   â”‚   <span class="dim">SKIP</span>
                                           â–¼
                                     Confidence
                                      â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
                              â–¼       â–¼       â–¼
                          <span class="green">â‰¥85%</span>    <span class="yellow">â‰¥65%</span>    <span class="accent">â‰¥50%</span>
                            â”‚       â”‚       â”‚
                          <span class="green">50Ã—</span>    <span class="yellow">25Ã—</span>    <span class="accent">15Ã—</span>
                            â”‚       â”‚       â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â–¼
                            <span class="purple">15m Momentum Check</span>
                                    â”‚
                               â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
                               â–¼         â–¼
                           <span class="green">ALIGNED</span>    <span class="dim">AGAINST</span>
                               â”‚         â”‚
                          <span class="green">OPEN TRADE</span>  <span class="dim">SKIP</span>
</pre>
                    </div>
                </div>
            </div>

            <!-- â•â•â• 5. Trade Lifecycle â•â•â• -->
            <div class="arch-section">
                <div class="arch-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <span class="emoji">ğŸ“ˆ</span>
                    <h2>Trade Lifecycle</h2>
                    <span class="toggle">â–¼</span>
                </div>
                <div class="arch-section-body">
                    <div class="arch-diagram">
                        <pre>
  <span class="green">ENTRY</span>                    <span class="yellow">ACTIVE</span>                        <span class="red">EXIT</span>
    â”‚                        â”‚                            â”‚
    â–¼                        â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Side    â”‚          â”‚ Every tick:  â”‚            â”‚ Reasons:     â”‚
â”‚ Entry $ â”‚          â”‚              â”‚            â”‚              â”‚
â”‚ Leverageâ”‚â”€â”€â”€â”€â”€â”€â–¶   â”‚ Update P&L   â”‚â”€â”€â”€â”€â”€â”€â–¶     â”‚ â€¢ STOP_LOSS  â”‚
â”‚ ATR     â”‚          â”‚ Track peak   â”‚            â”‚ â€¢ TAKE_PROFITâ”‚
â”‚ SL / TP â”‚          â”‚ Trail SL     â”‚            â”‚ â€¢ TRAILING_SLâ”‚
â”‚ Size    â”‚          â”‚ Extend TP    â”‚            â”‚ â€¢ TRAILING_TPâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ Check maxlossâ”‚            â”‚ â€¢ MAX_LOSS   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ â€¢ REGIME_CHG â”‚
                                                 â”‚ â€¢ KILL_SWITCHâ”‚
                                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                                                        â–¼
                                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                 â”‚ Log to CSV   â”‚
                                                 â”‚ Update P&L   â”‚
                                                 â”‚ Free capital  â”‚
                                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
                    </div>
                </div>
            </div>

            <!-- â•â•â• 6. Timeframes â•â•â• -->
            <div class="arch-section">
                <div class="arch-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <span class="emoji">â±ï¸</span>
                    <h2>Timeframe Strategy</h2>
                    <span class="toggle">â–¼</span>
                </div>
                <div class="arch-section-body">
                    <table class="config-table">
                        <thead>
                            <tr>
                                <th>Timeframe</th>
                                <th>Purpose</th>
                                <th>Used For</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="param-value">5m</span></td>
                                <td>Execution Timing</td>
                                <td>15m momentum filter (checks last 5 candles = 75min). Fine-tuned entry timing.</td>
                            </tr>
                            <tr>
                                <td><span class="param-value">1h</span></td>
                                <td>Primary Analysis</td>
                                <td>Main HMM training & prediction. Regime classification. ATR for SL/TP. All
                                    indicators.
                                </td>
                            </tr>
                            <tr>
                                <td><span class="param-value">4h</span></td>
                                <td>Macro Confirmation</td>
                                <td>Secondary HMM Brain. Filters out signals that conflict with macro trend. CRASH
                                    detection.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div><!-- /tab-integrations -->

        <!-- â•â•â• TAB 4: RESEARCH â•â•â• -->
        <div class="tab-pane" id="tab-research">

            <!-- Executive Summary -->
            <div class="arch-section">
                <div class="arch-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <span class="emoji">ğŸ“Š</span>
                    <h2>Executive Summary</h2>
                    <span class="toggle">â–¼</span>
                </div>
                <div class="arch-section-body">
                    <p style="color:var(--text-secondary);margin-bottom:16px;">Across <strong>60 experiments</strong> in
                        3 rounds, the current config (<code>5m / 2-feat / diag / 15-25-35x</code>) ranked near the
                        bottom. The optimized config delivers dramatically better results:</p>
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;">
                        <div
                            style="text-align:center;padding:16px;border-radius:12px;background:rgba(34,197,94,0.06);border:1px solid rgba(34,197,94,0.15);">
                            <div style="font-size:28px;font-weight:800;color:#22C55E;">6Ã—</div>
                            <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">Better Sharpe</div>
                            <div style="font-size:11px;color:var(--text-tertiary);">1.23 â†’ 8.13</div>
                        </div>
                        <div
                            style="text-align:center;padding:16px;border-radius:12px;background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.15);">
                            <div style="font-size:28px;font-weight:800;color:#3B82F6;">60%</div>
                            <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">Less Drawdown</div>
                            <div style="font-size:11px;color:var(--text-tertiary);">-60% â†’ -22%</div>
                        </div>
                        <div
                            style="text-align:center;padding:16px;border-radius:12px;background:rgba(139,92,246,0.06);border:1px solid rgba(139,92,246,0.15);">
                            <div style="font-size:28px;font-weight:800;color:#8B5CF6;">28Ã—</div>
                            <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">More Return</div>
                            <div style="font-size:11px;color:var(--text-tertiary);">+84% â†’ +2,378%</div>
                        </div>
                        <div
                            style="text-align:center;padding:16px;border-radius:12px;background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.15);">
                            <div style="font-size:28px;font-weight:800;color:#F59E0B;">5%</div>
                            <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">Fewer Trades</div>
                            <div style="font-size:11px;color:var(--text-tertiary);">78 â†’ 74</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Round 1: Architecture -->
            <div class="arch-section">
                <div class="arch-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <span class="emoji">ğŸ”¬</span>
                    <h2>Round 1 â€” Architecture (20 Experiments)</h2>
                    <span class="toggle">â–¼</span>
                </div>
                <div class="arch-section-body">
                    <table class="config-table">
                        <thead>
                            <tr>
                                <th>Variable</th>
                                <th>Best Config</th>
                                <th>Sharpe</th>
                                <th>MaxDD</th>
                                <th>Verdict</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Timeframe</strong></td>
                                <td class="param-value">15m</td>
                                <td>4.88</td>
                                <td>-45.9%</td>
                                <td>5m is too noisy; 15m is sweet spot</td>
                            </tr>
                            <tr>
                                <td><strong>Features</strong></td>
                                <td class="param-value">4-feat (+vol, RSI)</td>
                                <td>4.17</td>
                                <td>-94.1%</td>
                                <td>Volume + RSI improves classification</td>
                            </tr>
                            <tr>
                                <td><strong>Covariance</strong></td>
                                <td class="param-value">full on 15m</td>
                                <td>7.30</td>
                                <td>-25.9%</td>
                                <td>Captures cross-feature correlations</td>
                            </tr>
                            <tr>
                                <td><strong>Lookback</strong></td>
                                <td class="param-value">200-500</td>
                                <td>4.33</td>
                                <td>-91.2%</td>
                                <td>1000 = catastrophic overfitting</td>
                            </tr>
                            <tr>
                                <td><strong>States</strong></td>
                                <td class="param-value">3 or 4</td>
                                <td>8.09</td>
                                <td>â€”</td>
                                <td>5 states = too fragmented</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="logic-block green" style="margin-top:16px;">
                        <h4>Key Finding</h4>
                        <p>The <strong>best base config</strong> from Round 1 is:
                            <code>15m timeframe / 4 features / full covariance / 500 lookback</code>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Round 2: Leverage & Selectivity -->
            <div class="arch-section">
                <div class="arch-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <span class="emoji">ğŸ“ˆ</span>
                    <h2>Round 2 â€” Leverage & Selectivity (22 Experiments)</h2>
                    <span class="toggle">â–¼</span>
                </div>
                <div class="arch-section-body">
                    <p style="color:var(--text-secondary);margin-bottom:16px;">All 22 configs tested on optimal base
                        from Round 1. <strong>Every single one was profitable.</strong></p>
                    <table class="config-table" style="font-size:12px;">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Config</th>
                                <th>Return</th>
                                <th>MaxDD</th>
                                <th>Sharpe</th>
                                <th>PF</th>
                                <th>Trades</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ğŸ¥‡</td>
                                <td>50/35/25x @ 99/97/95%</td>
                                <td>+9,575%</td>
                                <td>-30.3%</td>
                                <td><strong>8.16</strong></td>
                                <td>1.52</td>
                                <td>77</td>
                            </tr>
                            <tr style="background:rgba(59,130,246,0.06);">
                                <td>ğŸ¥ˆ</td>
                                <td><strong>35/25/15x @ 99/96/92%</strong></td>
                                <td><strong>+2,378%</strong></td>
                                <td><strong>-22.3%</strong></td>
                                <td><strong>8.13</strong></td>
                                <td><strong>1.52</strong></td>
                                <td><strong>74</strong></td>
                            </tr>
                            <tr>
                                <td>ğŸ¥‰</td>
                                <td>20/15/10x @ 99/97/95%</td>
                                <td>+489%</td>
                                <td>-13.7%</td>
                                <td>7.88</td>
                                <td>1.50</td>
                                <td>77</td>
                            </tr>
                            <tr>
                                <td>4</td>
                                <td>35/25/15x @ 98/95/90%</td>
                                <td>+2,260%</td>
                                <td>-23.9%</td>
                                <td>7.80</td>
                                <td>1.48</td>
                                <td>74</td>
                            </tr>
                            <tr>
                                <td>5</td>
                                <td>40/30/20x @ 98/95/92%</td>
                                <td>+3,440%</td>
                                <td>-26.9%</td>
                                <td>7.67</td>
                                <td>1.46</td>
                                <td>74</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="logic-block" style="margin-top:16px;">
                        <h4>Key Findings</h4>
                        <ul>
                            <li><strong>Raising confidence thresholds is more impactful than reducing leverage.</strong>
                                Going from 85/91/95% â†’ 92/96/99% cuts trades by 5%, cuts DD by 14%, and increases Sharpe
                                by 10%.</li>
                            <li><strong>Current leverage tiers (15/25/35x) are already good.</strong> The improvement
                                comes from the confidence filter, not leverage changes.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Round 3: Timeframe Comparison -->
            <div class="arch-section">
                <div class="arch-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <span class="emoji">â±ï¸</span>
                    <h2>Round 3 â€” Timeframe Comparison (18 Experiments)</h2>
                    <span class="toggle">â–¼</span>
                </div>
                <div class="arch-section-body">
                    <p style="color:var(--text-secondary);margin-bottom:16px;">Direct comparison of 15m vs 30m vs 1h
                        across multiple configurations.</p>
                    <table class="config-table">
                        <thead>
                            <tr>
                                <th>Timeframe</th>
                                <th>Avg Sharpe</th>
                                <th>Avg Return</th>
                                <th>Avg MaxDD</th>
                                <th>Verdict</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background:rgba(34,197,94,0.06);">
                                <td class="param-value"><strong>15m</strong></td>
                                <td><strong>8.13</strong></td>
                                <td><strong>+2,378%</strong></td>
                                <td>-22.3%</td>
                                <td style="color:#22C55E;font-weight:600;">ğŸ† Clear winner</td>
                            </tr>
                            <tr>
                                <td class="param-value">30m</td>
                                <td>4.21</td>
                                <td>+890%</td>
                                <td>-35.1%</td>
                                <td>~2Ã— worse Sharpe</td>
                            </tr>
                            <tr>
                                <td class="param-value">1h</td>
                                <td>1.34</td>
                                <td>+120%</td>
                                <td>-52.8%</td>
                                <td>~6Ã— worse Sharpe</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recommended Profiles -->
            <div class="arch-section">
                <div class="arch-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <span class="emoji">ğŸ†</span>
                    <h2>Recommended Profiles</h2>
                    <span class="toggle">â–¼</span>
                </div>
                <div class="arch-section-body">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px;">
                        <div
                            style="padding:20px;border-radius:12px;border:2px solid rgba(74,222,128,0.2);background:rgba(74,222,128,0.04);">
                            <div style="font-size:28px;margin-bottom:8px;">ğŸ›¡ï¸</div>
                            <h3 style="margin:0 0 6px;color:#4ade80;">Conservative</h3>
                            <p style="font-size:11px;color:var(--text-tertiary);margin:0 0 10px;">Capital preservation,
                                lowest drawdown</p>
                            <ul
                                style="font-size:12px;color:var(--text-secondary);list-style:none;padding:0;margin:0;line-height:1.8;">
                                <li>Leverage: <strong>20x / 15x / 10x</strong></li>
                                <li>Confidence: <strong>99% / 97% / 95%</strong></li>
                                <li>Expected: <strong>+489%</strong> return, <strong>-13.7%</strong> MaxDD</li>
                                <li>Sharpe: <strong>7.88</strong></li>
                            </ul>
                        </div>
                        <div
                            style="padding:20px;border-radius:12px;border:3px solid rgba(59,130,246,0.3);background:rgba(59,130,246,0.06);box-shadow:0 0 20px rgba(59,130,246,0.1);">
                            <div style="font-size:28px;margin-bottom:8px;">âš–ï¸</div>
                            <h3 style="margin:0 0 2px;color:#3B82F6;">Balanced</h3>
                            <p style="font-size:10px;color:#3B82F6;font-weight:700;margin:0 0 10px;">â† CURRENTLY APPLIED
                            </p>
                            <ul
                                style="font-size:12px;color:var(--text-secondary);list-style:none;padding:0;margin:0;line-height:1.8;">
                                <li>Leverage: <strong>35x / 25x / 15x</strong></li>
                                <li>Confidence: <strong>99% / 96% / 92%</strong></li>
                                <li>Expected: <strong>+2,378%</strong> return, <strong>-22.3%</strong> MaxDD</li>
                                <li>Sharpe: <strong>8.13</strong></li>
                            </ul>
                        </div>
                        <div
                            style="padding:20px;border-radius:12px;border:2px solid rgba(248,113,113,0.2);background:rgba(248,113,113,0.04);">
                            <div style="font-size:28px;margin-bottom:8px;">ğŸ”¥</div>
                            <h3 style="margin:0 0 6px;color:#f87171;">Aggressive</h3>
                            <p style="font-size:11px;color:var(--text-tertiary);margin:0 0 10px;">Max returns, can
                                tolerate ~30% drawdowns</p>
                            <ul
                                style="font-size:12px;color:var(--text-secondary);list-style:none;padding:0;margin:0;line-height:1.8;">
                                <li>Leverage: <strong>50x / 35x / 25x</strong></li>
                                <li>Confidence: <strong>99% / 97% / 95%</strong></li>
                                <li>Expected: <strong>+9,575%</strong> return, <strong>-30.3%</strong> MaxDD</li>
                                <li>Sharpe: <strong>8.16</strong></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Applied Changes -->
            <div class="arch-section">
                <div class="arch-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <span class="emoji">âœ…</span>
                    <h2>Applied Changes</h2>
                    <span class="toggle">â–¼</span>
                </div>
                <div class="arch-section-body">
                    <p style="color:var(--text-secondary);margin-bottom:16px;">The following changes were applied based
                        on the Balanced profile recommendation:</p>
                    <table class="config-table">
                        <thead>
                            <tr>
                                <th>Setting</th>
                                <th>Before</th>
                                <th>After</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="param-name">TIMEFRAME_EXECUTION</span></td>
                                <td>5m</td>
                                <td class="param-value">15m</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">HMM_COVARIANCE</span></td>
                                <td>diag</td>
                                <td class="param-value">full</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">HMM_FEATURES</span></td>
                                <td>2 (log_return, volatility)</td>
                                <td class="param-value">4 (+volume_change, rsi_norm)</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">CONFIDENCE_HIGH</span></td>
                                <td>0.95</td>
                                <td class="param-value">0.99</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">CONFIDENCE_MEDIUM</span></td>
                                <td>0.91</td>
                                <td class="param-value">0.96</td>
                            </tr>
                            <tr>
                                <td><span class="param-name">CONFIDENCE_LOW</span></td>
                                <td>0.85</td>
                                <td class="param-value">0.92</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="logic-block yellow" style="margin-top:16px;">
                        <h4>âš ï¸ Caveats</h4>
                        <ul>
                            <li>Results are backtested on recent BTCUSDT data (~1000 candles). Live performance will be
                                lower.</li>
                            <li>Higher confidence filters (92%+) mean the bot will be idle more often but each trade has
                                higher conviction.</li>
                            <li>The 15m timeframe was confirmed as the clear winner across all tested configurations.
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

        </div><!-- /tab-research -->

        <!-- Footer -->
        <div style="text-align:center;padding:32px 0;color:var(--text-tertiary);font-size:12px;">
            SENTINEL Regime Engine v2.0 Â· Built with HMM + Multi-Timeframe Analysis
        </div>

    </div>

    <!-- â•â•â• Dynamic Config Loader â•â•â• -->
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  TAB SWITCHING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            btn.classList.add('active');
        }

        (async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                const cfg = await res.json();
                if (cfg.error) throw new Error(cfg.error);

                document.querySelectorAll('[data-cfg]').forEach(el => {
                    const key = el.dataset.cfg;
                    const fmt = el.dataset.fmt || '';
                    let val = cfg[key];
                    if (val === undefined) return;

                    if (fmt === 'x') val = val + 'Ã—';
                    else if (fmt === 'pct') {
                        const pv = val <= 1 && val > 0 ? val * 100 : val;
                        val = (pv % 1 === 0 ? pv.toFixed(0) : pv < 1 ? pv.toFixed(2) : pv.toFixed(1)) + '%';
                    }
                    else if (fmt === 'pctval') val = val + '%';
                    else if (fmt === 's') val = val + 's';
                    else if (fmt === '$') val = '$' + Number(val).toLocaleString();
                    else if (fmt === 'bool') val = val ? 'true' : 'false';

                    el.textContent = val;
                });

                document.getElementById('configStatus').textContent = 'âœ… Live from config.py';
                document.getElementById('configStatus').style.color = '#22C55E';
            } catch (e) {
                console.error('Failed to load config:', e);
                document.getElementById('configStatus').textContent = 'âš ï¸ Using defaults';
                document.getElementById('configStatus').style.color = '#F59E0B';
            }
        })();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  HMM CANVAS SIMULATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let hmmAnimFrame = null;
        const REGIMES = [
            { name: 'BULL', color: '#4ade80', drift: 0.003, vol: 0.01 },
            { name: 'BEAR', color: '#f87171', drift: -0.003, vol: 0.012 },
            { name: 'SIDEWAYS', color: '#facc15', drift: 0.0, vol: 0.005 },
            { name: 'CRASH', color: '#f472b6', drift: -0.008, vol: 0.025 },
        ];

        // Transition matrix (row=from, col=to)
        const T_MATRIX = [
            [0.85, 0.05, 0.08, 0.02],  // BULL
            [0.05, 0.80, 0.10, 0.05],  // BEAR
            [0.15, 0.15, 0.65, 0.05],  // SIDEWAYS
            [0.10, 0.30, 0.10, 0.50],  // CRASH
        ];

        function sampleTransition(fromState) {
            const r = Math.random();
            let cum = 0;
            for (let i = 0; i < 4; i++) {
                cum += T_MATRIX[fromState][i];
                if (r < cum) return i;
            }
            return 3;
        }

        function runHmmSimulation() {
            if (hmmAnimFrame) cancelAnimationFrame(hmmAnimFrame);
            const canvas = document.getElementById('hmmCanvas');
            const ctx = canvas.getContext('2d');
            const W = canvas.width, H = canvas.height;
            const N = 200; // data points
            const statusEl = document.getElementById('hmmSimStatus');

            // Generate synthetic price data with regime changes
            let state = Math.floor(Math.random() * 4);
            let price = 100;
            const prices = [price];
            const states = [state];

            for (let i = 1; i < N; i++) {
                state = sampleTransition(state);
                const regime = REGIMES[state];
                const ret = regime.drift + regime.vol * (Math.random() + Math.random() + Math.random() - 1.5) * 1.15;
                price *= (1 + ret);
                prices.push(price);
                states.push(state);
            }

            const minP = Math.min(...prices) * 0.98;
            const maxP = Math.max(...prices) * 1.02;

            // Animate drawing
            let drawn = 0;
            const speed = 3;

            function draw() {
                const end = Math.min(drawn + speed, N);

                // Clear
                ctx.clearRect(0, 0, W, H);

                // Draw regime background bands
                for (let i = 0; i < end; i++) {
                    const x = (i / N) * W;
                    const nextX = ((i + 1) / N) * W;
                    ctx.fillStyle = REGIMES[states[i]].color + '15';
                    ctx.fillRect(x, 0, nextX - x + 1, H);
                }

                // Draw grid lines
                ctx.strokeStyle = 'rgba(255,255,255,0.05)';
                ctx.lineWidth = 1;
                for (let i = 0; i < 5; i++) {
                    const y = (i / 4) * H;
                    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
                }

                // Draw price line
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let i = 0; i < end; i++) {
                    const x = (i / N) * W;
                    const y = H - ((prices[i] - minP) / (maxP - minP)) * (H - 20) - 10;
                    ctx.strokeStyle = REGIMES[states[i]].color;
                    if (i === 0) ctx.moveTo(x, y);
                    else {
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.strokeStyle = REGIMES[states[i]].color;
                        ctx.moveTo((((i - 1) / N) * W), H - ((prices[i - 1] - minP) / (maxP - minP)) * (H - 20) - 10);
                        ctx.lineTo(x, y);
                        ctx.stroke();
                        ctx.beginPath();
                    }
                }
                ctx.stroke();

                // Draw regime labels at transitions
                let lastState = -1;
                for (let i = 0; i < end; i++) {
                    if (states[i] !== lastState) {
                        lastState = states[i];
                        const x = (i / N) * W;
                        ctx.fillStyle = REGIMES[states[i]].color;
                        ctx.font = 'bold 10px Inter, sans-serif';
                        ctx.fillText(REGIMES[states[i]].name, x + 2, 14);
                    }
                }

                drawn = end;
                statusEl.textContent = `${drawn}/${N} candles`;

                if (drawn < N) {
                    hmmAnimFrame = requestAnimationFrame(draw);
                } else {
                    statusEl.textContent = `âœ… ${N} candles â€“ Simulation complete`;
                }
            }

            draw();
        }

        function resetHmmSimulation() {
            if (hmmAnimFrame) cancelAnimationFrame(hmmAnimFrame);
            const canvas = document.getElementById('hmmCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('hmmSimStatus').textContent = 'Ready';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  TELEGRAM INTEGRATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        (async function loadTelegramStatus() {
            try {
                const res = await fetch('/api/telegram/status');
                const data = await res.json();

                document.getElementById('tgBotToken').value = data.bot_token || 'Not configured';
                document.getElementById('tgChatId').value = data.chat_id || '';
                document.getElementById('tgEnabled').checked = data.enabled;
                document.getElementById('tgNotifyTrades').checked = data.notify_trades;
                document.getElementById('tgNotifyAlerts').checked = data.notify_alerts;
                document.getElementById('tgNotifySummary').checked = data.notify_summary;

                const badge = document.getElementById('tgStatusBadge');
                if (data.has_token && data.chat_id) {
                    badge.textContent = data.enabled ? 'ğŸŸ¢ Active' : 'ğŸŸ¡ Configured (disabled)';
                    badge.style.color = data.enabled ? '#4ade80' : '#facc15';
                } else if (data.has_token) {
                    badge.textContent = 'ğŸŸ¡ Token set, needs Chat ID';
                    badge.style.color = '#facc15';
                } else {
                    badge.textContent = 'âšª Not configured';
                    badge.style.color = 'var(--text-tertiary)';
                }

                // Initialize pause button state
                updatePauseButton(data.enabled);
            } catch (e) {
                document.getElementById('tgStatusBadge').textContent = 'âŒ Error loading';
            }
        })();

        async function detectChatId() {
            const statusEl = document.getElementById('tgActionStatus');
            statusEl.textContent = 'ğŸ” Detecting...';
            try {
                const res = await fetch('/api/telegram/detect-chat-id');
                const data = await res.json();
                if (data.success && data.chats.length > 0) {
                    const chat = data.chats[0];
                    document.getElementById('tgChatId').value = chat.id;
                    statusEl.textContent = `âœ… Found: ${chat.name} (${chat.type})`;
                    statusEl.style.color = '#4ade80';
                } else {
                    statusEl.textContent = data.message || 'âš ï¸ No chats found. Send /start to the bot first.';
                    statusEl.style.color = '#facc15';
                }
            } catch (e) {
                statusEl.textContent = 'âŒ Detection failed';
                statusEl.style.color = '#f87171';
            }
        }

        async function saveTelegramChatId() {
            const chatId = document.getElementById('tgChatId').value.trim();
            if (!chatId) { document.getElementById('tgActionStatus').textContent = 'âš ï¸ Enter a Chat ID first'; return; }
            try {
                const res = await fetch('/api/telegram/config', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: chatId }),
                });
                const data = await res.json();
                document.getElementById('tgActionStatus').textContent = data.success ? 'âœ… Chat ID saved!' : 'âŒ ' + data.error;
                document.getElementById('tgActionStatus').style.color = data.success ? '#4ade80' : '#f87171';
            } catch (e) {
                document.getElementById('tgActionStatus').textContent = 'âŒ Save failed';
            }
        }

        async function saveTelegramConfig() {
            try {
                await fetch('/api/telegram/config', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        enabled: document.getElementById('tgEnabled').checked,
                        notify_trades: document.getElementById('tgNotifyTrades').checked,
                        notify_alerts: document.getElementById('tgNotifyAlerts').checked,
                        notify_summary: document.getElementById('tgNotifySummary').checked,
                    }),
                });
            } catch (e) { console.error('Telegram config save error:', e); }
        }

        async function toggleTelegramPause() {
            const enabledCb = document.getElementById('tgEnabled');
            const wasEnabled = enabledCb.checked;
            const nowEnabled = !wasEnabled;  // Toggle state
            enabledCb.checked = nowEnabled;
            await saveTelegramConfig();
            updatePauseButton(nowEnabled);

            // Update status badge
            const badge = document.getElementById('tgStatusBadge');
            if (nowEnabled) {
                badge.textContent = 'ğŸŸ¢ Active';
                badge.style.color = '#4ade80';
            } else {
                badge.textContent = 'ğŸŸ¡ Configured (disabled)';
                badge.style.color = '#facc15';
            }

            const statusEl = document.getElementById('tgActionStatus');
            statusEl.textContent = nowEnabled ? 'â–¶ Notifications resumed' : 'â¸ Notifications paused';
            statusEl.style.color = nowEnabled ? '#4ade80' : '#facc15';
        }

        function updatePauseButton(isEnabled) {
            const btn = document.getElementById('tgPauseBtn');
            const icon = document.getElementById('tgPauseIcon');
            const label = document.getElementById('tgPauseLabel');
            if (!btn) return;
            if (isEnabled) {
                // Currently active â€” show "Pause" option
                btn.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                btn.style.background = 'rgba(239, 68, 68, 0.08)';
                btn.style.color = '#f87171';
                icon.textContent = 'â¸';
                label.textContent = 'Pause All Notifications';
            } else {
                // Currently paused â€” show "Resume" option
                btn.style.borderColor = 'rgba(74, 222, 128, 0.3)';
                btn.style.background = 'rgba(74, 222, 128, 0.08)';
                btn.style.color = '#4ade80';
                icon.textContent = 'â–¶';
                label.textContent = 'Resume Notifications';
            }
        }

        async function testTelegram() {
            const statusEl = document.getElementById('tgActionStatus');
            statusEl.textContent = 'ğŸ§ª Sending test...';
            statusEl.style.color = 'var(--text-secondary)';
            try {
                const chatId = document.getElementById('tgChatId').value.trim();
                const res = await fetch('/api/telegram/test', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: chatId }),
                });
                const data = await res.json();
                statusEl.textContent = data.success ? 'âœ… Test message sent!' : 'âŒ ' + (data.error || 'Failed');
                statusEl.style.color = data.success ? '#4ade80' : '#f87171';
            } catch (e) {
                statusEl.textContent = 'âŒ Test failed: ' + e.message;
                statusEl.style.color = '#f87171';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  REGIME ENGINE PRESETS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function applyPreset(preset) {
            const statusEl = document.getElementById('presetStatus');
            statusEl.style.display = 'block';
            statusEl.textContent = `â³ Applying ${preset} preset...`;
            statusEl.style.background = 'rgba(99,102,241,0.1)';
            statusEl.style.color = '#818cf8';

            // Visual feedback on cards
            document.querySelectorAll('.preset-card').forEach(c => c.style.transform = 'scale(1)');
            const card = document.getElementById('preset' + preset.charAt(0).toUpperCase() + preset.slice(1));
            if (card) card.style.transform = 'scale(1.02)';

            try {
                const res = await fetch('/api/config/preset', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ preset }),
                });
                const data = await res.json();

                if (data.success) {
                    statusEl.textContent = `âœ… ${preset.toUpperCase()} preset applied! ${data.applied.length} parameters updated. Takes effect on next bot cycle.`;
                    statusEl.style.background = 'rgba(74,222,128,0.1)';
                    statusEl.style.color = '#4ade80';

                    // Highlight active card
                    document.querySelectorAll('.preset-card').forEach(c => {
                        c.style.boxShadow = 'none';
                        c.style.borderWidth = '2px';
                    });
                    if (card) {
                        card.style.boxShadow = '0 0 20px rgba(99,102,241,0.3)';
                        card.style.borderWidth = '3px';
                    }
                } else {
                    statusEl.textContent = `âŒ ${data.error}`;
                    statusEl.style.background = 'rgba(248,113,113,0.1)';
                    statusEl.style.color = '#f87171';
                }
            } catch (e) {
                statusEl.textContent = 'âŒ Failed to apply preset: ' + e.message;
                statusEl.style.background = 'rgba(248,113,113,0.1)';
                statusEl.style.color = '#f87171';
            }
        }
    </script>

    <script src="/mode-toggle.js"></script>
</body>

</html>